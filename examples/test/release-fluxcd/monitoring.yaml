apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: prometheus-community
  namespace: flux-system
spec:
  url: https://prometheus-community.github.io/helm-charts/
  interval: 10m
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: monitoring
  namespace: flux-system
spec:
  dependsOn:
    - name: kube-ovn
      namespace: flux-system
  interval: 10m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 72.3.1
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  targetNamespace: monitoring
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    alertmanager:
      enabled: false

    kubeStateMetrics:
      enabled: true

    prometheus:
      prometheusSpec:
        serviceMonitorSelectorNilUsesHelmValues: false

    grafana:
      grafana.ini:
        auth.anonymous:
          enabled: true
          org_role: Viewer
        http:
          enable_cors: true
          allow_from_origin: "*"
        server:
          root_url: /grafana
          serve_from_sub_path: true

    prometheus-node-exporter:
      prometheus:
        monitor:
          attachMetadata:
            node: true
          relabelings:
          - action: replace
            sourceLabels: [__meta_kubernetes_node_name]
            targetLabel: nodename
